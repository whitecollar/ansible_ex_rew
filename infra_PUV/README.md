Общие положения.

Правила использования репозитория:
1) Создать ветку от мастера при добавлении/изменении конфигов, название ветки должно начинаться с названия задачи в "Jira", например: "PFRPUV-2825_CD_payment-app". 
2) При добавлении роли сперва выполнить пункты "Правила добавления новых ролей."
3) Занести соответствующие хосты в "inventories/dev/hosts" и в "inventories/testing/hosts"
4) Удалить все хосты из файла "inventories/hosts". 
4) Проверить свой МР.
5) Сбросить ссылку на МР коллегам.

Правила добавления новых ролей.
1) Наименование роли должно отображать название приложения без упоминания докера, т.к. у нас и так всё в докере.
2) Имя хоста окружения "dev" занести в нужные группы в файл "inventories/for_test_new_role/hosts", удалив из него все остальные хосты, если они есть.
3) В файл "inventories/for_test_new_role/group_vars/all.yml" добавить так же необходимые для хоста переменные.
4) Роль должна быть включена в плейбук "provision.yml".
5) Создать МР, ОБЯЗАТЕЛЬНО поставив галочку напротив полей "Delete source branch" и "Squash commits".
6) Роль должна быть полностью и без ошибок установлена в ходе папйлайна МР на стенд.
7) В случае ошибок, в ходе выполнения установки роли, необходимо удалить с хоста всё, что было на этапах до ошибки, исправить ошибку и перезапустить пайплайн.
 7.1) Для отладки можно использовать ключ "-v" кол-во букв "v" показывает насколько подробюен будет вывод.
 7.2) Отладка и, собственно, весь пайплайн производится на стадии "ansible-provision-new-host" в файле ".gitlab-ci.yml".
8) В ходе пайплайна все задачи плейбука для новой роли должны быть "changed".


Плейбук provision.yml включает в себя все роли по умолчанию. Запускается вручную после внесения изменений в этот репозиторий ветки master.

Плейбуки deploy.yml и deploy_compose.yml выполняют прописанную для них роль. Запускаются по триггеру после создания нового образа в определённых ветках разработчиков в группе проектов: https://dpr-gitlab.otr.ru/puv/

Замечание: В связи с полноценным переходом на сервисы docker, в текущий момент используются только те хосты с соответствующими ролями, на которых уже полноценно идёт работа.
В текущий момент это серверы приложений.


Роли.
Более подробное описание по установке каждой роли есть в комментариях.

1. Роль init.
Для CentOS и RHEL7.2
Служит для подключения базовых репозиториев, установки необходимых пакетов для последующей установки. Включает установку ПО для обслуживания.
Устанавливается на все хосты по умолчанию.

3. Роль pip.
Служит для установки пакетов python нужных для модулей ansible. Устанавливается на все хосты по умолчанию.

4. Роль docker.
Служит для установки и конфигурирования docker, docker-compose и portainer.
Устанавливается по умолчанию на хосты группы app.

5. Роль deploy.
Служит для разворачивания прикладного ПО на хосте в докере.

6. Роль deploy_compose.
Служит для разворачивания прикладного ПО на хосте с помощью docker-compose.